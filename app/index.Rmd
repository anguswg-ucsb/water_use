---
title: "Water use"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    navbar:
      - { icon: "fa-question-circle", href: "https://github.com/anguswg-ucsb/water_use", align: right }
    theme: flatly
    orientation: rows
    source_code: embed
    vertical_layout: fill
---


```{r setup, include = FALSE}
library(shiny)
library(flexdashboard)
library(shinyWidgets)

library(dplyr)
library(tidyr)
library(dataRetrieval)

library(DT)
library(highcharter)

source('utils.R')
```


```{r context="server"}
#Initialize Maps 
# output$conusMap     <- renderLeaflet({ basemap() })

state_lst <- data.frame(state = state.name)
counties <- USAboundaries::us_counties()



# output$countyMap <- renderLeaflet({ pop_map(pop) })

```

US water use {data-icon="fa-tint"}
=====================================

Inputs {.sidebar}
-------------------------------------

### Model Filters
```{r}
dateRangeInput("dateTS", label = "Date Range Input",
               start = "1993-01-01",
               end = "2018-12-31",
               min = "1993-01-01",
               max = "2018-12-31",
               format = "yyyy mm dd",
               weekstart = 1)
uiOutput("stateSelect")
uiOutput("countySelect")
uiOutput("sectorSelect")

verbatimTextOutput("stateText")

verbatimTextOutput("sectorText")

verbatimTextOutput("countyText")

```

```{r context="server"}
sector_lst <- data.frame(source = c("public","domestic","commericial","industrial",
                "thermoelectric", "livestock","mining",
                "wastewater", "irrigation", "hydro","aqua"))



output$stateSelect <- renderUI({
   selectInput("stateSearch", "Choose state:",
               as.list(unique(counties$state_name)),
               multiple= FALSE,
               selectize = TRUE)
})
output$countySelect <- renderUI({
   selectInput("countySearch", "Choose county:",
               choices = NULL,
               multiple= FALSE,
               selectize = TRUE)
})

output$sectorSelect <- renderUI({
   selectInput("sectorSearch", "Choose sector:",
               choices = as.list(sector_lst),
               multiple= FALSE,
               selectize = TRUE)
})

```

### **Submit**
```{r}
shiny::actionButton("submitButton", label = "Enter", icon("search"))
```

Row
-----------------------------------------------
```{r context="server"}
# stateName <- eventReactive(input$submitButton, {
#     filter(counties, state_name == input$stateSearch)
#   })
stateName <- reactive({
  if(is.null(input$stateSearch)){
    NULL
  } else {
    filter(counties, state_name == input$stateSearch)
  }
  })
observeEvent(stateName(), {
  choices <- stateName()$name
  updateSelectInput(session, inputId = "countySearch", choices = choices)

})
output$stateText <- renderPrint({
  input$stateSearch
  })

countyName <- eventReactive(input$submitButton, {
    input$countySearch
  })
# countyName <- reactive({
#     # input$countySearch
#   req(input$customername)
#   filter(stateName(), name == input$countySearch)
#   })
output$countyText <- renderPrint({
   countyName()
  })

sectorName <- eventReactive(input$submitButton, {
    s <- filter(sector_lst, source == input$sectorSearch) 
    s[1,]
  
    
  })
output$sectorText <- renderPrint({
  sectorName()
})
```


### Table
```{r}

# verbatimTextOutput("countyText")

DTOutput("tableWaterUse")
```

```{r context = "server"}
output$tableWaterUse <- renderDT({

  df <- dataRetrieval::readNWISuse(input$stateSearch, countyName()) %>%
    janitor::clean_names()
  tbl <- tidy_cols(df, sectorName())
  DT::datatable(tbl, fillContainer = TRUE)
})
```

Row
----------------------------------------------
### graph
```{r}
highchartOutput("waterUseGraph")
```

```{r context = "server"}
# county water use data/plot, reactive to input of date button
countyWaterUse <- eventReactive(input$submitButton, {
    
      df <- dataRetrieval::readNWISuse(input$stateSearch, countyName()) %>%
            janitor::clean_names()

        make_graph(df, sectorName())
  
})
# Render water use plot after action button is clicked
output$waterUseGraph <- renderHighchart({
        countyWaterUse()
      })
```













