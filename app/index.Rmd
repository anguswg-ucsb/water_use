---
title: "Water use"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    navbar:
      - { icon: "fa-question-circle", href: "https://github.com/anguswg-ucsb/water_use", align: right }
    theme: flatly
    orientation: rows
    source_code: embed
    vertical_layout: fill
---


```{r setup, include = FALSE}
library(shiny)
library(flexdashboard)
library(shinyWidgets)

library(dplyr)
library(tidyr)
library(janitor)
library(stringr)
library(dataRetrieval)

library(DT)
library(highcharter)

source('utils.R')
```


```{r context="server"}
#Initialize Maps 
# output$conusMap     <- renderLeaflet({ basemap() })

state_lst <- data.frame(state = state.name)
county_lst <- USAboundaries::us_counties() %>% 
  sf::st_drop_geometry()


water_use <<- reactive({
    df <- dataRetrieval::readNWISuse(stateCd= state()$state_name[1], countyCd = county()) %>%
            clean_names()
})


# output$countyMap <- renderLeaflet({ pop_map(pop) })

```

US water use {data-icon="fa-tint"}
=====================================

Inputs {.sidebar}
-------------------------------------

### Model Filters
```{r}
dateRangeInput("dateTS", label = "Date Range Input",
               start = "1993-01-01",
               end = "2018-12-31",
               min = "1993-01-01",
               max = "2018-12-31",
               format = "yyyy mm dd",
               weekstart = 1)
uiOutput("stateSelect")
uiOutput("countySelect")
uiOutput("usageSelect")
uiOutput("sectorSelect")


```

```{r context="server"}
sector_lst <- data.frame(source = c("public","domestic","commericial","industrial",
                "thermoelectric", "livestock","mining",
                "wastewater", "irrigation", "hydro","aqua", "geothermal", "fossil_fuel"))
usage <- data.frame(source = c("consumptive", "withdrawals"))


output$stateSelect <- renderUI({
   selectInput("stateSearch", "Choose state:",
               as.list(unique(county_lst$state_name)),
               multiple= FALSE,
               selectize = TRUE)
})
output$countySelect <- renderUI({
   selectInput("countySearch", "Choose county:",
               choices = NULL,
               multiple= FALSE,
               selectize = TRUE)
})
output$usageSelect <- renderUI({
   selectInput("usageSearch", "Sink:",
               choices = c("consumptive", "withdrawals"),
               multiple= FALSE,
               selectize = TRUE)
})
output$sectorSelect <- renderUI({
   selectInput("sectorSearch", "Choose sector:",
               choices = as.list(sector_lst),
               multiple= FALSE,
               selectize = TRUE)
})

```

### **Submit**
```{r}
shiny::actionButton("submitButton", label = "Enter", icon("search"))
```

Row
-----------------------------------------------
```{r context="server"}
# state <- eventReactive(input$submitButton, {
#     filter(county_lst, state_name == input$stateSearch)
#   })
state <- reactive({
  if(is.null(input$stateSearch)){
    NULL
  } else {
    filter(county_lst, state_name == input$stateSearch)
  }
  })

usage <- reactive({
  input$usageSearch
})
output$usageText <- renderPrint({
  usage()
  })
observeEvent(state(), {
  choices <- state()$name
  updateSelectInput(session, inputId = "countySearch", choices = choices)

})
output$stateText <- renderPrint({
  state()
  })

county <- reactive({
  input$countySearch
})

output$countyText <- renderPrint({
   county()
  })

waterData <- eventReactive(input$submitButton, {
     df <- tidy_sectors(water_use())
     if(!is.null(input$usageSearch) && is.null(input$sectorSearch)) {
       df <- df %>% filter(str_detect(sector, usage()))
       DT::datatable(df, fillContainer = TRUE)
     } else if(!is.null(input$usageSearch) && !is.null(input$sectorSearch)) {
       df <- df %>%
         filter(str_detect(sector, usage())) %>%
          filter(str_detect(sector, sector()))
       DT::datatable(df, fillContainer = TRUE)
     }
})

output$waterDT <- renderDT({
  waterData()
})

#     janitor::clean_names()
#   tbl <- tidy_cols(df, sectorName())
#   DT::datatable(tbl, fillContainer = TRUE)
# county <- eventReactive(input$submitButton, {
#     input$countySearch
#   })
# county <- reactive({
#     # input$countySearch
#   req(input$customername)
#   filter(state(), name == input$countySearch)
#   })
# output$countyText <- renderPrint({
#    county()
#   })

# sectorName <- eventReactive(input$submitButton, {
#     s <- filter(sector_lst, source == input$sectorSearch)
#     s[1,]
# 
# 
#   })
sector <- reactive({
  input$sectorSearch
})
output$sectorText <- renderPrint({
  sector()
})
```


### Table
```{r}

# verbatimTextOutput("countyText")
# verbatimTextOutput("stateText")

# verbatimTextOutput("sectorText")

DTOutput("waterDT")
```

```{r context = "server"}
# output$tableWaterUse <- renderDT({
# 
#   df <- dataRetrieval::readNWISuse(input$stateSearch, county()) %>%
#     janitor::clean_names()
#   tbl <- tidy_cols(df, sectorName())
#   DT::datatable(tbl, fillContainer = TRUE)
# })
```

Row
----------------------------------------------
### graph
```{r}
# highchartOutput("waterUseGraph")
verbatimTextOutput("countyText")

```

### state
```{r}
verbatimTextOutput("stateText")
```

### Usage
```{r}
verbatimTextOutput("usageText")
```

```{r context = "server"}
# county water use data/plot, reactive to input of date button
# countyWaterUse <- eventReactive(input$submitButton, {
#     
#       df <- dataRetrieval::readNWISuse(input$stateSearch, county()) %>%
#             janitor::clean_names()
# 
#         make_graph(df, sectorName())
#   
# })
# # Render water use plot after action button is clicked
# output$waterUseGraph <- renderHighchart({
#         countyWaterUse()

#       })
```
Row
--------------------------------------
```{r}
verbatimTextOutput('sectorText')
```













